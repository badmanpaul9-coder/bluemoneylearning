<!DOCTYPE html>
<html>
<body style="width:100vw;height:100vh;margin:0;padding:0;overflow:hidden">
<script>
var gamPath = "https://cdn.jsdelivr.net/gh/bluemoneylearning/bluemoneylearning@main/Games/g/Ruffle/swfs/worldshardestgame.js";

// Helper functions (unchanged)
function loadScripts(scripts, callback){
  var loadedCount = 0;
  function scriptLoaded(){
    loadedCount++ ;
    if(loadedCount === scripts.length){
      callback(null);
    }
  }
  scripts.forEach(function (script){
    var scriptTag = document.createElement('script');
    scriptTag.src = script;
    scriptTag.onload = scriptLoaded;
    scriptTag.onerror = function() {
      callback(new Error('Failed to load script: ' + script));
    };
    document.head.appendChild(scriptTag);
  });
}
function generateRandomString() {
  var chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var result = '';
  for (var i = 0; i < 10; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

var channel = generateRandomString();
const bc = new BroadcastChannel(channel);

loadScripts([gamPath], function (error){
  if (error) {
    alert('Failed to load scripts: ' + error.message);
    console.error('Failed to load scripts:', error);
    return;
  }

    var frame = document.createElement('iframe');
    frame.setAttribute('frameborder', 0);
    frame.style.width = '100%';
    frame.style.height = '100%';
    frame.style.margin = '0';
    frame.style.padding = '0';
    frame.onload = function() {
     bc.postMessage({type: "swf", data: window.data});
    };
    
    // The frame must be in the DOM before we can write to its document.
    document.body.appendChild(frame); 

    // --- Applying the requested fetch/write method ---

    const url = "https://cdn.jsdelivr.net/gh/bluemoneylearning/bluemoneylearning@latest/Games/g/Ruffle/player.html?channel=" + channel;
    
    // This is the crucial part for making relative paths work
    const baseUrl = url.substring(0, url.lastIndexOf('/') + 1);

    fetch(url)
      .then(r => r.text()) // Get the raw text, ignoring the text/plain MIME type
      .then(html => {
        // Fix the HTML by injecting a <base> tag. This tells the document
        // where to load relative assets like "ruffle.js" from.
        const processedHtml = html.replace('<head>', `<head><base href=\"${baseUrl}\">`);

        // Get the iframe's document and write the content into it,
        // which forces the browser to parse it as HTML.
        const iframeDocument = frame.contentDocument || frame.contentWindow.document;
        iframeDocument.open();
        iframeDocument.write(processedHtml);
        iframeDocument.close();
      })
      .catch(err => {
        console.error('Failed to load and process game player:', err);
      });
});

bc.onmessage = (event) => {
   var eventType = (event.data.type);
   if (eventType == 'close') {
    bc.close();
   }
};
</script>
</body>
</html>